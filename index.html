<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily English Bite</title>
    <style>
        :root { --primary: #58cc02; --text: #3c3c3c; --bg: #f7f7f7; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Header */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .date { font-size: 0.9em; color: #888; font-weight: bold; }
        .counter { background: #fff5c2; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.9em; color: #ffa500; }
        
        /* Sections */
        h2 { color: var(--primary); font-size: 1.4em; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 30px; }
        .article-title { font-size: 1.8em; margin: 10px 0; line-height: 1.3; color: #222; }
        
        /* Vocab */
        .vocab-item { background: #f0fbf0; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .vocab-word { font-weight: bold; font-size: 1.1em; }
        .vocab-meaning { color: #555; }
        .vocab-ex { font-style: italic; color: #666; font-size: 0.9em; margin-top: 4px; display: block;}

        /* Quiz */
        .quiz-item { margin-bottom: 20px; }
        .options button { display: block; width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #eee; border-radius: 10px; background: white; cursor: pointer; text-align: left; transition: 0.2s; }
        .options button:hover { background: #f9f9f9; }
        .options button.correct { background: #dff6dd; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .options button.wrong { background: #ffebeb; border-color: #ff4b4b; color: #ff4b4b; }

        /* Loader */
        #loader { text-align: center; padding: 50px; }
        .hidden { display: none; }
        
        /* Complete Message */
        #complete-msg { text-align: center; margin-top: 30px; display: none; }
        .success-stamp { font-size: 3em; animation: pop 0.5s ease; }
        @keyframes pop { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="date" id="date-display">Loading...</div>
        <div class="counter">ğŸ† <span id="streak-count">-</span></div>
    </header>

    <div id="loader">ì˜¤ëŠ˜ì˜ ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... ğŸ—ï¸</div>

    <div id="content" class="hidden">
        <h1 class="article-title" id="title"></h1>
        
        <h2>ğŸ’¡ Vocabulary</h2>
        <div id="vocab-list"></div>

        <h2>ğŸ“– Article</h2>
        <div id="article-text"></div>

        <h2>âœ… Quiz</h2>
        <div id="quiz-list"></div>
        
        <div id="complete-msg">
            <div class="success-stamp">ğŸ‰</div>
            <h3>Great Job!</h3>
            <p>ì˜¤ëŠ˜ì˜ í•™ìŠµì„ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
</div>

<script>
    // **********************************************
    // ì—¬ê¸°ì— ë³µì‚¬í•œ GAS ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš”
    // **********************************************
    const GAS_URL = "https://script.google.com/macros/s/AKfycby1UzmkbUKf0ZPBW1KmcHfeej9IoXxeEMdzNJyexBnfizqZTI0-8qUPH_oUeBlVChY/exec"; 

    let quizData = [];
    let correctCount = 0;

    // 1. ë°ì´í„° ë¡œë“œ
    async function loadContent() {
        try {
            const res = await fetch(`${GAS_URL}?action=getContent`);
            const json = await res.json();
            
            if (json.error) {
                document.getElementById('loader').innerText = json.error;
                return;
            }

            render(json.content);
            document.getElementById('streak-count').innerText = json.count;
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

        } catch (e) {
            document.getElementById('loader').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            console.error(e);
        }
    }

    // 2. í™”ë©´ ë Œë”ë§
    function render(data) {
        document.getElementById('date-display').innerText = data.date;
        document.getElementById('title').innerText = data.headline;
        document.getElementById('article-text').innerHTML = data.article.replace(/\n/g, '<br><br>');

        // ë‹¨ì–´
        const vocabContainer = document.getElementById('vocab-list');
        data.vocab.forEach(v => {
            vocabContainer.innerHTML += `
                <div class="vocab-item">
                    <span class="vocab-word">${v.word}</span>
                    <span class="vocab-meaning"> - ${v.meaning}</span>
                    <span class="vocab-ex">"${v.example}"</span>
                </div>`;
        });

        // í€´ì¦ˆ
        quizData = data.quiz;
        const quizContainer = document.getElementById('quiz-list');
        quizData.forEach((q, idx) => {
            let optionsHtml = '';
            q.options.forEach((opt, optIdx) => {
                optionsHtml += `<button onclick="checkAnswer(this, ${idx}, ${optIdx})">${opt}</button>`;
            });
            
            quizContainer.innerHTML += `
                <div class="quiz-item" id="q-${idx}">
                    <p><strong>Q${idx + 1}.</strong> ${q.question}</p>
                    <div class="options">${optionsHtml}</div>
                </div>`;
        });
    }

    // 3. ì •ë‹µ í™•ì¸
    function checkAnswer(btn, qIdx, selectedOpt) {
        const parent = btn.parentElement;
        const buttons = parent.querySelectorAll('button');
        const correctAnswer = quizData[qIdx].answer;

        // ì´ë¯¸ í‘¼ ë¬¸ì œëŠ” í´ë¦­ ë°©ì§€
        if (parent.dataset.answered) return;
        parent.dataset.answered = "true";

        if (selectedOpt === correctAnswer) {
            btn.classList.add('correct');
            correctCount++;
        } else {
            btn.classList.add('wrong');
            buttons[correctAnswer].classList.add('correct'); // ì •ë‹µ ë³´ì—¬ì£¼ê¸°
        }

        // ëª¨ë“  ë¬¸ì œë¥¼ í’€ì—ˆëŠ”ì§€ í™•ì¸
        const answeredCount = document.querySelectorAll('.options[data-answered="true"]').length;
        if (answeredCount === quizData.length) {
            finishStudy();
        }
    }

    // 4. í•™ìŠµ ì™„ë£Œ ì²˜ë¦¬
    async function finishStudy() {
        document.getElementById('complete-msg').style.display = 'block';
        
        // ì„œë²„ì— ì¹´ìš´íŠ¸ ì¦ê°€ ìš”ì²­
        try {
            const res = await fetch(`${GAS_URL}?action=markComplete`);
            const json = await res.json();
            if (json.success) {
                document.getElementById('streak-count').innerText = json.count;
            }
        } catch (e) {
            console.error("ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", e);
        }
    }

    // ì‹œì‘
    loadContent();
</script>

</body>
</html>
